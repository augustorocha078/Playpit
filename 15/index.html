<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Humidifier | Playpit 14</title>
	<script src="/common/js/three.min.js" type="text/javascript" ></script>
	
	<script src="/common/js/Detector.js" type="text/javascript" charset="utf-8"></script>
	<script src="/common/js/SimplexNoise.js" type="text/javascript" charset="utf-8"></script>
	<script src="/common/js/controls/TrackballControls.js" type="text/javascript" charset="utf-8"></script>

	<script src="/common/js/shaders/VignetteShader.js" type="text/javascript" charset="utf-8"></script>
	<script src="/common/js/shaders/CopyShader.js" type="text/javascript" charset="utf-8"></script>
	<script src="/common/js/shaders/ConvolutionShader.js" type="text/javascript" charset="utf-8"></script>
	<script src="/common/js/postprocessing/RenderPass.js" type="text/javascript" charset="utf-8"></script>
	<script src="/common/js/postprocessing/ShaderPass.js" type="text/javascript" charset="utf-8"></script>
	<script src="/common/js/postprocessing/MaskPass.js" type="text/javascript" charset="utf-8"></script>
	<script src="/common/js/postprocessing/BloomPass.js" type="text/javascript" charset="utf-8"></script>
	<script src="/common/js/postprocessing/EffectComposer.js" type="text/javascript" charset="utf-8"></script>
	<script src="/common/js/shaders/BleachBypassShader.js"></script>
	<script src="/common/js/shaders/FXAAShader.js"></script>

	<script src="/common/js/shaders/UnpackDepthRGBAShader.js"></script>

	<!-- shader -->
	<script type="x-shader/x-vertex" id="vertexshader">
		attribute float size;
		attribute vec3 ca;
		attribute float alpha;
		varying vec3 vColor;
		varying float vAlpha;
		const float PI = 3.1415;
		float r =45.0*PI/180.0;
		void main(){
			mat4 rotate = mat4(
		         cos( r ), sin( r ), 0.0, 0.0,
		        -sin( r ), cos( r ), 0.0, 0.0,
		              0.0,      0.0, 1.0, 0.0,
		              0.0,      0.0, 0.0, 1.0
		    );
			vColor = ca;
			vAlpha = alpha;
			vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
			gl_PointSize = size*(300.0/length(mvPosition.xyz));
			gl_Position = projectionMatrix * mvPosition;

		}
	</script>

	<script type="x-shader/x-fragment" id="fragmentshader">
		uniform vec3 color;
		uniform sampler2D texture;
		varying vec3 vColor;
		varying float vAlpha;
		void main(){
			gl_FragColor = vec4(color*vColor, vAlpha);
			gl_FragColor = gl_FragColor*texture2D(texture, gl_PointCoord);
		}
	</script>

	
	<style>
		 body{
			margin:0;
			padding:0;
			background-color:#706f6e;
			overflow: hidden;	
		}
	</style>
	<link rel="stylesheet" href="../common/js/gui/gui.css" type="text/css" media="screen" title="no title" charset="utf-8">
	
</head>

<body>

	<script type="text/javascript">

		var container;
		var scene, camera, renderer;
		var composerScene;

		var SHADOW_MAP_WIDTH = 2048, SHADOW_MAP_HEIGHT = 1024;
		var SCREEN_WIDTH = window.innerWidth;
		var SCREEN_HEIGHT = window.innerHeight;

		var mousex=0, mousey=0;

		var pSystem;
		var particleNum = 3000;
		var uniforms, attributes;

		var radius = 2;
		var yLimit = 100;
		var lifes = [];

		var simplexNoise = new SimplexNoise();
		var t0=0, t1=0;

		var trackballControls = new THREE.TrackballControls();

		window.addEventListener('load', function(){
			init();
			resize();
			animate();
		});


		function init(){
			container = document.createElement('div');
			document.body.appendChild( container );
			
			scene = new THREE.Scene(); 
			scene.fog = new THREE.Fog(0x706f6e, 50, 400);
			camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight);
			camera.position.set(0,50,100);

			trackballControls = new THREE.TrackballControls(camera);

			renderer = new THREE.WebGLRenderer({
				antialias:true
			});
			renderer.autoClear = false;
			renderer.setClearColor( 0xcccccc, 1 );
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.shadowMapEnabled = true;
			renderer.shadowMapType = THREE.PCFShadowMap;
			container.appendChild( renderer.domElement );

			//light
			var ambientLight = new THREE.AmbientLight(0x4d4b4a);
			scene.add(ambientLight);

			var spotLight1 = new THREE.SpotLight( 0xffffff, 0.8, 10000, true );
			spotLight1.color.setHSV( 0.05, 0.05, 1 );
			spotLight1.position.set( -30, 30, 150 );
			spotLight1.lookAt( scene.position );
			spotLight1.castShadow = true;
			spotLight1.shadowCameraNear = 10;
			spotLight1.shadowCameraFar = camera.far;
			spotLight1.shadowCameraFov = 50;
			spotLight1.shadowBias = 0.0001;
			spotLight1.shadowDarkness = 0.3;
			spotLight1.shadowMapWidth = 2048;
			spotLight1.shadowMapHeight = 2048;
			// spotLight1.shadowCameraVisible = true;
			scene.add( spotLight1 );

			var pointLight2 = new THREE.PointLight( 0xffffff, 0.1, 10000 );
			pointLight2.color.setHSV( 0.05, 0.05, 1 );
			pointLight2.position.set( 600, -600, -600 );
			scene.add( pointLight2 );

			//particle system

			attributes = {
				size: {	type: 'f', value: [] },
				ca:   {	type: 'c', value: [] },
				alpha: { type: 'f', value: [] }
			}
			uniforms = {
				amplitude: { type: "f", value: 1.0 },
				color:     { type: "c", value: new THREE.Color( 0xffffff ) },
				texture:   { type: "t", value: THREE.ImageUtils.loadTexture( "circle.png" ) },
			}
			uniforms.texture.value.wrapS = uniforms.texture.value.wrapS = THREE.RepeatWrapping;
			var pShaderMaterial = new THREE.ShaderMaterial({
				uniforms: uniforms,
				attributes: attributes,
				vertexShader: document.getElementById('vertexshader').textContent,
				fragmentShader: document.getElementById('fragmentshader').textContent,
				transparent: true,
			})

			var pGeom = new THREE.Geometry();
			for(var i=0; i<particleNum; i++){
				var ang = Math.random()*Math.PI*2;
				var r = radius*Math.random();
				var p = new THREE.Vector3( 
					r*Math.cos(ang),
					yLimit*(Math.random()), 
					r*Math.sin(ang)
				);
				pGeom.vertices.push( p );
				lifes[i] = Math.random()*300 + 200;
				attributes.size.value[i] = 5;
				attributes.ca.value[i] = new THREE.Color(0xffffff);
				attributes.alpha.value[i] = 0.5;
			}
			pGeom.dynamic = true;
			pSystem = new THREE.ParticleSystem(pGeom, pShaderMaterial);
			pSystem.sortParticles = true;
			pSystem.position.y = -50;

			scene.add(pSystem);


			//postprocessing
			//Vignette
			var effectVignette = new THREE.ShaderPass( THREE.VignetteShader );
			effectVignette.uniforms['offset'].value = 0.1;
			effectVignette.uniforms['darkness'].value=0.10;
			effectVignette.renderToScreen = true;

			//bloom
			var effectBloom = new THREE.BloomPass( 0.4 );
			var effectBleach = new THREE.ShaderPass( THREE.BleachBypassShader );
			var effectFXAA = new THREE.ShaderPass( THREE.FXAAShader );
			effectFXAA.uniforms[ 'resolution' ].value.set( 1 / window.innerWidth, 1 / window.innerHeight );

			var renderTargetParameter = {
				minFilter: THREE.LinearFilter, 
				magFilter: THREE.LinearFilter, 
				format: THREE.RGBFormat, 
				stencilBuffer: false
			};
			var renderTarget = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight, renderTargetParameter);

			var renderModel = new THREE.RenderPass( scene, camera );	
			composerScene = new THREE.EffectComposer( renderer, renderTarget );
			composerScene.addPass( renderModel );
			// composerScene.addPass( effectBloom );
			composerScene.addPass( effectBleach );
			composerScene.addPass( effectFXAA );
			composerScene.addPass( effectVignette );


			//event
			document.addEventListener('mousemove', mouseMove);
			window.addEventListener('resize', resize, false);

		}



		function animate(){
			requestAnimationFrame(animate);

			//particleMovement

			//console.log(perlin.noise(0.5,0.5,100))
			var pGeom = pSystem.geometry;
			for(var j=0; j<particleNum; j++){

				var p = pGeom.vertices[j];
				var v = p.clone();
				var rnd0 = simplexNoise.noise3d( t0+p.x*0.020, t0+(p.y)*0.020, t0+(j/particleNum)*(p.z)*0.150 )*p.y*p.y*0.00015;
				var rnd1 = simplexNoise.noise3d( t1+p.x*0.020, t1+(p.y)*0.020, t1+(j/particleNum)*(p.z)*0.300 )*p.y*p.y*0.00015;
				v.x = rnd0;
				v.z = rnd1;
				v.y = rnd0+0.4;

				p.addSelf(v);

				attributes.size.value[j]*=1.015;
				// attributes.size.value[j]*=0.995;
				attributes.alpha.value[j]*=0.999;

				if(lifes[j]--<0){
					var ang = Math.random()*Math.PI*2;
					var r = radius*Math.random();
					p.x = r*Math.cos(ang);
					p.y = 0;
					p.z = r*Math.sin(ang);
					lifes[j] = Math.random()*300+150;
					attributes.size.value[j]=1;
					attributes.alpha.value[j]=0.02;
				}
			}
			pGeom.verticesNeedUpdate = true;
			attributes.size.needsUpdate = true;
			attributes.alpha.needsUpdate = true;
			t0+=Math.random()*0.005;
			t1+=Math.random()*0.005;

			//camera
			// var tx = 150*mousex/window.innerWidth;
			// var tz = 300*(mousey/window.innerHeight);
			// if(tz>0) tz*=-1;
			// tz += 180;
			// var ty = 100*mousey/window.innerHeight;
			// var tv = new THREE.Vector3(tx,ty,tz);
			// camera.position.addSelf( tv.subSelf(camera.position).multiplyScalar(0.1) )
			// camera.lookAt( scene.position )
			
			render();

			trackballControls.update();
		}

		function render(){
			renderer.setClearColor( scene.fog.color, 1 );
			// renderer.render(scene, camera);
			composerScene.render(0.01);

		}

		function resize() {
			var stageWidth = window.innerWidth;
			var stageHeight = window.innerHeight;
			camera.aspect = stageWidth / stageHeight;
			renderer.setSize(stageWidth, stageHeight)
			camera.updateProjectionMatrix();
		}

		function mouseMove(ev){

			omx = mousex;
			omy = mousey;
			mousex = ev.clientX - window.innerWidth / 2;
			mousey = ev.clientY - window.innerHeight / 2;

		}


	</script>
</body>
</html>